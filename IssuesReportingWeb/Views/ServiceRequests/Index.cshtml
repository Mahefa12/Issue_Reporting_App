@model IssuesReportingWeb.Controllers.ServiceRequestsController.ServiceRequestsViewModel
@{
    ViewData["Title"] = "Service Requests (MVC)";
    var items = Model.Items;
    if (Model.StartDate.HasValue || Model.EndDate.HasValue)
    {
        var sd = Model.StartDate?.Date ?? DateTime.MinValue;
        var ed = (Model.EndDate?.Date ?? DateTime.MaxValue).AddDays(1).AddTicks(-1);
        // Compare in local time for visual consistency
        items = items.Where(r => {
            var d = r.CreatedDate.ToLocalTime();
            return d >= sd && d <= ed;
        }).ToList();
    }
}

<div class="page-header">
    <h1>Service Requests</h1>
</div>

<form method="get" action="/ServiceRequests" class="mb-3">
    <div class="row g-2 align-items-end">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" name="SearchQuery" value="@(Model.SearchQuery ?? Model.IdentifierQuery)" list="request-suggestions" placeholder="Search by title or ID (e.g., ISSUE-1 or Streetlight repair)" />
                <button type="submit" class="btn btn-primary btn-pill">Search</button>
            </div>
            <div class="form-text">Type a title or identifier; select a suggestion or click Search.</div>
            <datalist id="request-suggestions">
                @foreach (var r in items)
                {
                    <option value="@r.Identifier" label="@r.Title"></option>
                    <option value="@r.Title" label="@r.Identifier"></option>
                }
            </datalist>
        </div>
        <div class="col-md-3">
            <label class="form-label">Created from</label>
            <input type="date" class="form-control" name="StartDate" value="@(Model.StartDate?.ToString("yyyy-MM-dd"))" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Created to</label>
            <div class="input-group">
                <input type="date" class="form-control" name="EndDate" value="@(Model.EndDate?.ToString("yyyy-MM-dd"))" />
                <button type="submit" class="btn btn-outline-secondary btn-pill">Apply</button>
                <button type="button" id="btn-clear" class="btn btn-outline-danger btn-pill">Clear</button>
            </div>
        </div>
    </div>
</form>

@if (Model.TrackedRequest != null)
{
    var r = Model.TrackedRequest;
    <div class="card mb-3 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <h5 class="card-title mb-0">@r.Title <small class="text-muted">(@r.Identifier)</small></h5>
                <span class="chip">@((r.Status == IssuesReportingApp.Models.ServiceRequestStatus.InProgress) ? "In Progress" : r.Status.ToString())</span>
            </div>
            <p class="card-text">@r.Description</p>
            <div class="mb-2">
                <span class="chip">@r.Category</span>
                <span class="chip warn">Priority @r.Priority</span>
            </div>
            @if (Model.DependencyPath?.Any() == true)
            {
                <div>
                    <strong>Dependencies:</strong>
                    <div class="d-flex flex-wrap gap-2 mt-1">
                        @foreach (var step in Model.DependencyPath)
                        {
                            <span class="chip">@step</span>
                        }
                    </div>
                </div>
            }
            @if (Model.DependencyBackbone != null && Model.DependencyBackbone.Count > 0)
            {
                <div class="mt-3">
                    <strong>Minimal dependency backbone (MST):</strong>
                    <div class="d-flex flex-column gap-1 mt-1">
                        @foreach (var edge in Model.DependencyBackbone)
                        {
                            <span class="chip">@edge.u â†’ @edge.v</span>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

<h3 class="mb-2">All Requests</h3>
<div class="row g-3">
    <div class="col-12">
        <table class="table table-striped table-hover align-middle table-modern">
            <thead>
                <tr>
                    <th>Identifier</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var r in items)
            {
                <tr>
                    <td class="fw-semibold">@r.Identifier</td>
                    <td>@r.Title</td>
                    <td><span class="chip">@((r.Status == IssuesReportingApp.Models.ServiceRequestStatus.InProgress) ? "In Progress" : r.Status.ToString())</span></td>
                    <td><span class="chip warn">@r.Priority</span></td>
                    <td>@r.CreatedDate.ToLocalTime().ToString("g")</td>
                    <td>
                        <div class="d-flex gap-2">
                            <a class="btn btn-primary btn-sm" href="/ServiceRequests?identifierQuery=@r.Identifier">Track</a>
                            <button type="button" class="btn btn-outline-secondary btn-sm copy-id" data-copy-id="@r.Identifier">Copy ID</button>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    }
</div>

<script>
  (function(){
    var form = document.querySelector('form[action="/ServiceRequests"]');
    var btnClear = document.getElementById('btn-clear');
    if (btnClear && form) {
      btnClear.addEventListener('click', function(){
        var sd = form.querySelector('input[name="StartDate"]');
        var ed = form.querySelector('input[name="EndDate"]');
        var sq = form.querySelector('input[name="SearchQuery"]');
        if (sd) sd.value = '';
        if (ed) ed.value = '';
        if (sq) sq.value = '';
        // Submit to show all items
        form.submit();
      });
    }
    document.querySelectorAll('.copy-id').forEach(function(btn){
      btn.addEventListener('click', function(){
        var id = btn.getAttribute('data-copy-id');
        if (!id) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(id).then(function(){
            var prev = btn.textContent;
            btn.textContent = 'Copied';
            setTimeout(function(){ btn.textContent = prev; }, 1200);
          }).catch(function(){ alert('Copy failed'); });
        } else {
          var ta = document.createElement('textarea');
          ta.value = id; document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); } catch(e) {}
          document.body.removeChild(ta);
          var prev = btn.textContent;
          btn.textContent = 'Copied';
          setTimeout(function(){ btn.textContent = prev; }, 1200);
        }
      });
    });
  })();
</script>